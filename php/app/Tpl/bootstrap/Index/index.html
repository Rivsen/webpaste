<h1 class="center-title">A Web Paste and Edit site!</h1>
<div class="row">
  <div class="span2 sidebar">
    <select id="mode">
    <foreach name="mode" item="vo">
      <if condition="$vo eq $code['mode']">
      <option value="{$vo}" selected>{$vo}</option>
      <else />
      <option value="{$vo}">{$vo}</option>
      </if>
    </foreach>
    </select>
    <button class="span1 btn btn-primary btn-submit" id="submit">提交</button>
    <div class="alert alert-success"></div>
    <div class="alert alert-error"></div>
  </div>
  <div class="span10">
    <pre id="editor">{$code['code']}</pre>
  </div>
</div>
<script>
  var editor = ace.edit("editor");
  editor.setTheme("ace/theme/dawn");
  <if condition="$show eq true">
  editor.getSession().setMode("ace/mode/{$code['mode']}");
  <else />
  editor.getSession().setMode();
  </if>
  editor.getSession().setUseSoftTabs(true);
  //editor.setReadOnly(true);

  var height = $(window).height() - $($('.center-title')[0]).height() - 160;
  $('#editor').height(height);

  $(window).resize(function(){
    height = $(window).height() - $($('.center-title')[0]).height() - 160;
    $('#editor').height(height);
    editor.resize();
  });

  var id = '{$id}';

  $('#submit').click(function(){
    var code = editor.getSession().getValue();
    var mode = $('#mode').val();
    var params = {mode: mode, code: code};
    if( id != '' ) {
      params.id = id;
    }
    var post = $.post(
      '{:U('Index/submit')}?'+Math.random(),
      params,
      function(data){
        console.log(data);
        if( data.status > 0 ) {
          $('.sidebar .alert-success').html(data.info);
          $('.sidebar .alert-success').show();
          id = data.data;
        } else {
          $('.sidebar .alert-error').html(data.info);
          $('.sidebar .alert-error').show();
        }
      },
      'json'
    );
  });

  $('#mode').change(function(){
    var mode = $(this).val();
    if( mode != 'text' ) {
      editor.getSession().setMode("ace/mode/"+mode);
    } else {
      editor.getSession().setMode();
    }
  });
</script>
